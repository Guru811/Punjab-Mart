#include <iostream>
#include <vector>
#include <unordered_map>
#include <algorithm>
#include <string>
#include <map>
#include <cmath>
#include <ctime>

using namespace std;

// ===================== Product Class ===================== //
// Represents an individual product in the store
class Product {
    int id;             // Unique product ID
    string name;        // Product name
    double price;       // Product price
    int stock;          // Available stock
    string expiry;      // Expiry date (optional)
public:
    Product(int i, string n, double p, int s, string e = "") : id(i), name(n), price(p), stock(s), expiry(e) {}

// Getter functions
    int getId() const { return id; }
    string getName() const { return name; }
    double getPrice() const { return price; }
    int getStock() const { return stock; }
    string getExpiry() const { return expiry; }

// Functions to modify stock and price
    void reduceStock(int qty) { stock -= qty; }
    void increaseStock(int qty) { stock += qty; }
    void setPrice(double p) { price = p; }
};

// ===================== Cart Class ===================== //
// Represents a user's shopping cart
class Cart {
    unordered_map<int, int> items;  // Map of ProductID -> Quantity
public:
    void addItem(int productId, int qty) { items[productId] += qty; }
    void removeItem(int productId) { items.erase(productId); }
    void updateItem(int productId, int qty) { if(qty>0) items[productId] = qty; else items.erase(productId); }
    unordered_map<int,int>& getItems() { return items; }
    void clear() { items.clear(); }
    bool empty() const { return items.empty(); }
};

// ===================== Coupon Structure ===================== //
// Represents a promo code/coupon
struct Coupon {
    string code;
    string description;
    double discountPercent;
    double minPurchaseAmount;
    double maxDiscountAmount;
    bool isActive;
    string expiryDate;
    
    Coupon(string c, string desc, double discount, double minPurchase, double maxDiscount, string expiry)
        : code(c), description(desc), discountPercent(discount),
          minPurchaseAmount(minPurchase), maxDiscountAmount(maxDiscount),
          isActive(true), expiryDate(expiry) {}

    // Checks if the input code matches this coupon
    bool isValidCode(const string& inputCode) const {
        if (!isActive) return false;
        string lower1 = code, lower2 = inputCode;
        transform(lower1.begin(), lower1.end(), lower1.begin(), ::tolower);
        transform(lower2.begin(), lower2.end(), lower2.begin(), ::tolower);
        return lower1 == lower2;
    }

    // ✅ Corrected discount logic
    double calculateDiscount(double amount) const {
        if (amount < minPurchaseAmount) return 0.0;
        double discount = amount * (discountPercent / 100.0);
        if (maxDiscountAmount > 0 && discount > maxDiscountAmount)
            discount = maxDiscountAmount;
        return discount;
    }

    // Displays coupon details
    void displayCoupon() const {
        cout << "\nCode: " << code << "\n";
        cout << "Description: " << description << "\n";
        cout << "Discount: " << discountPercent << "%\n";
        cout << "Min Purchase: ₹" << minPurchaseAmount << "\n";
        if (maxDiscountAmount > 0)
            cout << "Max Discount: ₹" << maxDiscountAmount << "\n";
        cout << "Valid Until: " << expiryDate << "\n";
        cout << "Status: " << (isActive ? "Active" : "Expired") << "\n";
    }
};


// ===================== EMI Plan Structure ===================== //
// Represents an EMI option for high-value purchases
struct EMIPlan {
    int tenure;
    double interestRate;
    
    EMIPlan(int t, double r) : tenure(t), interestRate(r) {}
    
 // Calculates monthly EMI for a given principal
    double calculateEMI(double principal) const {
        double monthlyRate = interestRate / (12 * 100);
        int months = tenure;
        
        if(monthlyRate == 0) {
            return principal / months;
        }
        
        double emi = (principal * monthlyRate * pow(1 + monthlyRate, months)) / 
                     (pow(1 + monthlyRate, months) - 1);
        return emi;
    }
    
// Displays detailed EMI breakdown
    void displayEMIBreakdown(double principal) const {
        double emi = calculateEMI(principal);
        double totalAmount = emi * tenure;
        double totalInterest = totalAmount - principal;
        
        cout << "\n=== EMI Breakdown ===\n";
        cout << "Principal Amount: ₹" << principal << "\n";
        cout << "Interest Rate: " << interestRate << "% per annum\n";
        cout << "Tenure: " << tenure << " months\n";
        cout << "Monthly EMI: ₹" << emi << "\n";
        cout << "Total Interest: ₹" << totalInterest << "\n";
        cout << "Total Amount Payable: ₹" << totalAmount << "\n";
        
        cout << "\nMonth-wise Payment Schedule:\n";
        cout << "Month\tEMI\t\tBalance\n";
        cout << "----------------------------------------\n";
        
        double balance = principal;
        for(int i = 1; i <= tenure; i++) {
            double interest = balance * (interestRate / (12 * 100));
            double principalPaid = emi - interest;
            balance -= principalPaid;
            
            cout << i << "\t₹" << emi << "\t₹" << (balance > 0 ? balance : 0) << "\n";
        }
    }
};

// ===================== Order Structure ===================== //
// Represents a placed order
struct Order {
    int orderId;
    unordered_map<int,int> items;   // ProductID -> Quantity
    double totalAmount;
    string paymentMethod;
    string deliveryAddress;
};

// ===================== User Class ===================== //
// Represents a user of the store
class User {
    string name;
    Cart cart;
    vector<Order> orders;  // Store all placed orders
public:
    User(string n) : name(n) {}
    string getName() const { return name; }
    Cart& getCart() { return cart; }
    void addOrder(const Order& o) { orders.push_back(o); }
    const vector<Order>& getOrders() const { return orders; }
};

// ===================== Display Functions ===================== //
void displayWelcomeBadge() {
    cout << "=============================================\n";
    cout << "     🛒  Welcome to PUNJAB MART  🛍️     \n";
    cout << "   Quality • Variety • Fast Delivery • Trust  \n";
    cout << "=============================================\n\n";
}

// Display list of products
void showProducts(const vector<Product>& products) {
    cout << "\nID\tName\t\t\tPrice\tStock\tExpiry\n";
    cout << "--------------------------------------------------------------\n";
    for(const auto& p : products) {
        cout << p.getId() << "\t" << p.getName();
        if(p.getName().length() < 15) cout << "\t\t"; else cout << "\t";
        cout << "₹" << p.getPrice() << "\t" << p.getStock() << "\t";
        if(!p.getExpiry().empty()) cout << p.getExpiry();
        else cout << "-";
        cout << "\n";
    }
}

// Display Available Coupons
void displayAvailableCoupons(const vector<Coupon>& coupons) {
    cout << "\n========================================\n";
    cout << "       AVAILABLE PROMO CODES            \n";
    cout << "========================================\n";
    
    for(const auto& coupon : coupons) {
        if(coupon.isActive) {
            coupon.displayCoupon();
            cout << "----------------------------------------\n";
        }
    }
}

// Validate and Apply Coupon
pair<bool, double> applyCoupon(const vector<Coupon>& coupons, const string& inputCode, double amount) {
    for(const auto& coupon : coupons) {
        if(coupon.isValidCode(inputCode)) {
            if(amount < coupon.minPurchaseAmount) {
                cout << "\nCoupon '" << inputCode << "' requires minimum purchase of ₹" 
                     << coupon.minPurchaseAmount << "\n";
                cout << "Your cart total: ₹" << amount << "\n";
                cout << "Add ₹" << (coupon.minPurchaseAmount - amount) << " more to use this coupon.\n";
                return {false, 0.0};
            }
            
            double discount = coupon.calculateDiscount(amount);
            cout << "\n✓ Coupon Applied Successfully!\n";
            cout << "Coupon: " << coupon.code << " - " << coupon.description << "\n";
            cout << "Discount: ₹" << discount << " (" << coupon.discountPercent << "%)\n";
            return {true, discount};
        }
    }
    
    cout << "\n✗ Invalid Coupon Code!\n";
    return {false, 0.0};
}

// Process Payment with EMI Option
string processPayment(double amount) {
    int payChoice;
    string paymentMethod;
    
    cout << "\n========================================\n";
    cout << "        SELECT PAYMENT METHOD           \n";
    cout << "========================================\n";
    cout << "1. Credit Card\n";
    cout << "2. Debit Card\n";
    cout << "3. UPI ID\n";
    cout << "4. Cash on Delivery\n";
    cout << "5. EMI (Equated Monthly Installments)\n";
    cout << "========================================\n";
    cout << "Enter choice: ";
    cin >> payChoice;
    cin.ignore();

    switch(payChoice) {
        case 1: {
            string ccNum, ccName, ccExpiry, ccCVV;
            cout << "\n--- Credit Card Payment ---\n";
            cout << "Enter Credit Card Number: ";
            getline(cin, ccNum);
            cout << "Enter Name on Card: ";
            getline(cin, ccName);
            cout << "Enter Expiry Date (MM/YY): ";
            getline(cin, ccExpiry);
            cout << "Enter CVV: ";
            getline(cin, ccCVV);
            cout << "\nProcessing Credit Card Payment of ₹" << amount << "...\n";
            cout << "✓ Payment Successful!\n";
            paymentMethod = "Credit Card";
            break;
        }
        case 2: {
            string dcNum, dcName, dcExpiry, dcCVV;
            cout << "\n--- Debit Card Payment ---\n";
            cout << "Enter Debit Card Number: ";
            getline(cin, dcNum);
            cout << "Enter Name on Card: ";
            getline(cin, dcName);
            cout << "Enter Expiry Date (MM/YY): ";
            getline(cin, dcExpiry);
            cout << "Enter CVV: ";
            getline(cin, dcCVV);
            cout << "\nProcessing Debit Card Payment of ₹" << amount << "...\n";
            cout << "✓ Payment Successful!\n";
            paymentMethod = "Debit Card";
            break;
        }
        case 3: {
            string upiId;
            cout << "\n--- UPI Payment ---\n";
            cout << "Enter UPI ID: ";
            getline(cin, upiId);
            cout << "\nProcessing UPI Payment of ₹" << amount << "...\n";
            cout << "✓ Payment Successful!\n";
            paymentMethod = "UPI";
            break;
        }
        case 4: {
            cout << "\n--- Cash on Delivery ---\n";
            cout << "Total Amount to pay on delivery: ₹" << amount << "\n";
            cout << "✓ Order Confirmed! Please pay the delivery agent.\n";
            paymentMethod = "Cash on Delivery";
            break;
        }
        case 5: {
            cout << "\n========================================\n";
            cout << "            EMI PAYMENT OPTIONS           \n";
            cout << "========================================\n";
            
            if(amount < 5000) {
                cout << "EMI is available only for purchases above ₹5000.\n";
                cout << "Your cart total: ₹" << amount << "\n";
                cout << "Please select another payment method.\n";
                return processPayment(amount);
            }
            
            vector<EMIPlan> emiPlans = {
                EMIPlan(3, 12.0),   EMIPlan(6, 13.5),   EMIPlan(9, 14.0),
                EMIPlan(12, 15.0),  EMIPlan(18, 16.0),  EMIPlan(24, 17.0)
            };
            
            cout << "\nSelect EMI Tenure:\n";
            for(int i = 0; i < emiPlans.size(); i++) {
                double emi = emiPlans[i].calculateEMI(amount);
                cout << (i+1) << ". " << emiPlans[i].tenure << " months @ " 
                     << emiPlans[i].interestRate << "% p.a. - Monthly EMI: ₹" << emi << "\n";
            }
            
            cout << "\nEnter choice (1-" << emiPlans.size() << "): ";
            int emiChoice;
            cin >> emiChoice;
            cin.ignore();
            
            if(emiChoice < 1 || emiChoice > emiPlans.size()) {
                cout << "Invalid choice. Please try again.\n";
                return processPayment(amount);
            }
            
            EMIPlan selectedPlan = emiPlans[emiChoice - 1];
            selectedPlan.displayEMIBreakdown(amount);
            
            cout << "\nConfirm EMI Payment? (yes/no): ";
            string confirm;
            getline(cin, confirm);
            
            if(confirm == "yes" || confirm == "y") {
                cout << "\n--- EMI Payment Processing ---\n";
                cout << "Enter Credit/Debit Card Number: ";
                string cardNum;
                getline(cin, cardNum);
                cout << "Enter Name on Card: ";
                string cardName;
                getline(cin, cardName);
                cout << "Enter Expiry Date (MM/YY): ";
                string expiry;
                getline(cin, expiry);
                cout << "Enter CVV: ";
                string cvv;
                getline(cin, cvv);
                
                cout << "\nProcessing EMI Payment...\n";
                cout << "✓ EMI Payment Successful!\n";
                cout << "First EMI of ₹" << selectedPlan.calculateEMI(amount) 
                     << " will be deducted on " << selectedPlan.tenure << " monthly cycles.\n";
                
                paymentMethod = "EMI (" + to_string(selectedPlan.tenure) + " months)";
            } else {
                cout << "EMI payment cancelled. Please select another payment method.\n";
                return processPayment(amount);
            }
            break;
        }
        default:
            cout << "Invalid payment option. Please try again.\n";
            return processPayment(amount);
    }
    
    return paymentMethod;
}

void searchProduct(map<string, vector<Product>>& categories, const string& keyword) {
    cout << "\nSearch Results for \"" << keyword << "\":\n";
    cout << "ID\tName\t\t\tPrice\tStock\tExpiry\n";
    cout << "--------------------------------------------------------------\n";
    bool foundAny = false;

    string keyLower = keyword;
    transform(keyLower.begin(), keyLower.end(), keyLower.begin(), ::tolower);

    for(auto& cat : categories) {
        string catNameLower = cat.first;
        transform(catNameLower.begin(), catNameLower.end(), catNameLower.begin(), ::tolower);

        // If category matches keyword, show all products in that category
        if(catNameLower.find(keyLower) != string::npos) {
            for(auto& p : cat.second) {
                foundAny = true;
                cout << p.getId() << "\t" << p.getName();
                if(p.getName().length() < 15) cout << "\t\t"; else cout << "\t";
                cout << "₹" << p.getPrice() << "\t" << p.getStock() << "\t";
                if(!p.getExpiry().empty()) cout << p.getExpiry();
                else cout << "-";
                cout << "\n";
            }
        } else {
            // Otherwise, search products individually
            for(auto& p : cat.second) {
                string nameLower = p.getName(); 
                transform(nameLower.begin(), nameLower.end(), nameLower.begin(), ::tolower);
                if(nameLower.find(keyLower) != string::npos) {
                    foundAny = true;
                    cout << p.getId() << "\t" << p.getName();
                    if(p.getName().length() < 15) cout << "\t\t"; else cout << "\t";
                    cout << "₹" << p.getPrice() << "\t" << p.getStock() << "\t";
                    if(!p.getExpiry().empty()) cout << p.getExpiry();
                    else cout << "-";
                    cout << "\n";
                }
            }
        }
    }
    if(!foundAny) cout << "No products found matching the keyword.\n";
}
void exchangeProduct(User& user, map<string, vector<Product>>& categories, int oldPid, int newPid, int newQty) {
    bool foundOld = false, foundNew = false;
    Product* newProduct = nullptr;

    for(auto& cat : categories) {
        for(auto& p : cat.second) {
            if(p.getId() == oldPid) foundOld = true;
            if(p.getId() == newPid) {
                newProduct = &p;
                foundNew = true;
            }
        }
    }

    if(!foundOld) {
        cout << "Old Product ID not in catalog.\n";
        return;
    }
    if(!foundNew) {
        cout << "New Product ID not found.\n";
        return;
    }
    if(newQty <= 0 || newQty > newProduct->getStock()) {
        cout << "Invalid quantity for new product.\n";
        return;
    }

    user.getCart().removeItem(oldPid);
    user.getCart().addItem(newPid, newQty);
    cout << "Product exchange successful. Old product removed, new product added to cart.\n";
}

void removeFromCart(User& user) {
    cout << "Enter Product ID to remove from cart: ";
    int pid;
    cin >> pid;
    cin.ignore();
    auto& items = user.getCart().getItems();
    if(items.find(pid) != items.end()) {
        user.getCart().removeItem(pid);
        cout << "Product removed from cart.\n";
    } else {
        cout << "Product ID not found in cart.\n";
    }
}

void updateCartQuantity(User& user, map<string, vector<Product>>& categories) {
    cout << "Enter Product ID to update quantity: ";
    int pid, qty;
    cin >> pid;
    cout << "Enter new quantity: ";
    cin >> qty;
    cin.ignore();

    Product* pptr = nullptr;
    for(auto& cat : categories) {
        for(auto& p : cat.second) {
            if(p.getId() == pid) {
                pptr = &p;
                break;
            }
        }
    }

    if(pptr == nullptr) {
        cout << "Product ID not found in catalog.\n";
        return;
    }
    if(qty <= 0 || qty > pptr->getStock()) {
        cout << "Invalid quantity or insufficient stock.\n";
        return;
    }

    user.getCart().updateItem(pid, qty);
    cout << "Cart updated successfully.\n";
}
    
    // ===================== Cancel Order Function (Updated) ===================== //
// Cancels a specific product or entire order, removes it from order history, and restocks
void cancelOrder(User& user, map<string, vector<Product>>& categories) {
    vector<Order>& orders = const_cast<vector<Order>&>(user.getOrders()); // allow modification
    if (orders.empty()) {
        cout << "\nNo previous orders found to cancel.\n";
        return;
    }

    cout << "\n=========== ORDER CANCELLATION ===========\n";
    for (size_t i = 0; i < orders.size(); ++i) {
        cout << i + 1 << ". Order ID: " << orders[i].orderId
             << " | Total: ₹" << orders[i].totalAmount
             << " | Payment: " << orders[i].paymentMethod << "\n";
    }

    cout << "Enter the number of the order you want to cancel: ";
    int orderChoice;
    cin >> orderChoice;
    cin.ignore();

    if (orderChoice < 1 || orderChoice > (int)orders.size()) {
        cout << "Invalid order selection.\n";
        return;
    }

    Order& selectedOrder = orders[orderChoice - 1];
    if (selectedOrder.items.empty()) {
        cout << "This order has already been cancelled.\n";
        return;
    }

    cout << "\nOrder #" << selectedOrder.orderId << " contains:\n";
    for (const auto& item : selectedOrder.items) {
        int pid = item.first;
        int qty = item.second;
        for (auto& cat : categories) {
            for (auto& p : cat.second) {
                if (p.getId() == pid) {
                    cout << pid << " - " << p.getName() << " x" << qty << "\n";
                }
            }
        }
    }

    cout << "\nDo you want to cancel the entire order or a single product?\n";
    cout << "1. Entire Order\n2. Single Product\nEnter choice: ";
    int cancelType;
    cin >> cancelType;
    cin.ignore();

    if (cancelType == 1) {
        cout << "Enter reason for full order cancellation: ";
        string reason;
        getline(cin, reason);

        // Restock all items in the cancelled order
        for (const auto& item : selectedOrder.items) {
            int pid = item.first;
            int qty = item.second;
            for (auto& cat : categories) {
                for (auto& p : cat.second) {
                    if (p.getId() == pid) {
                        p.increaseStock(qty);
                        break;
                    }
                }
            }
        }

        cout << "\nOrder #" << selectedOrder.orderId << " cancelled successfully.\n";
        cout << "Reason: " << reason << "\n";
        cout << "Refund (if prepaid) will be processed within 2-3 working days.\n";

        // Remove this order entirely from history
        orders.erase(orders.begin() + (orderChoice - 1));
    } 
    else if (cancelType == 2) {
        cout << "Enter Product ID to cancel: ";
        int cancelPid;
        cin >> cancelPid;
        cin.ignore();

        auto it = selectedOrder.items.find(cancelPid);
        if (it == selectedOrder.items.end()) {
            cout << "Product not found in this order.\n";
            return;
        }

        string prodName;
        int cancelQty = it->second;
        for (auto& cat : categories) {
            for (auto& p : cat.second) {
                if (p.getId() == cancelPid) {
                    prodName = p.getName();
                    p.increaseStock(cancelQty); // Restock cancelled item
                    break;
                }
            }
        }

        cout << "\nEnter reason for cancellation: ";
        string reason;
        getline(cin, reason);

        cout << "\nAre you sure you want to cancel \"" << prodName << "\"? (yes/no): ";
        string confirm;
        getline(cin, confirm);

        if (confirm == "yes" || confirm == "y") {
            selectedOrder.items.erase(it);  // Remove from order
            cout << "\nProduct cancelled successfully!\n";
            cout << "Product: " << prodName << "\n";
            cout << "Quantity: " << cancelQty << "\n";
            cout << "Reason: " << reason << "\n";
            cout << "Refund (if prepaid) will be processed within 2-3 working days.\n";

            // If no items left in the order, remove the order entirely
            if (selectedOrder.items.empty()) {
                orders.erase(orders.begin() + (orderChoice - 1));
                cout << "\nAll products in this order are cancelled. Order removed from history.\n";
            }
        } else {
            cout << "Cancellation aborted.\n";
        }
    } 
    else {
        cout << "Invalid choice.\n";
    }
}

int main() {
    displayWelcomeBadge();

    // Initialize Available Coupons
    vector<Coupon> availableCoupons = {
        Coupon("WELCOME10", "Welcome offer - 10% off", 10.0, 500.0, 500.0, "31-12-2025"),
        Coupon("SAVE20", "Save 20% on orders above ₹1000", 20.0, 1000.0, 1000.0, "31-12-2025"),
        Coupon("FESTIVE25", "Festive season special - 25% off", 25.0, 2000.0, 1500.0, "31-12-2025"),
        Coupon("FLAT50", "Flat ₹50 off on all orders", 5.0, 500.0, 50.0, "31-12-2025"),
        Coupon("MEGA30", "Mega sale - 30% off on ₹5000+", 30.0, 5000.0, 2000.0, "31-12-2025"),
        Coupon("FIRST100", "First order - ₹100 off", 10.0, 1000.0, 100.0, "31-12-2025"),
        Coupon("NEWUSER15", "New user special - 15% off", 15.0, 750.0, 1200.0, "31-12-2025")
    };

    map<string, vector<Product>> categories = {
        {"Electronics", { Product(1, "Laptop", 65000.0, 10), Product(2, "Smartphone", 35000.0, 20), Product(3, "Headphones", 3500.0, 15), Product(4, "Smartwatch", 7000.0, 8),
                          Product(11, "LED TV", 30000.0, 12), Product(12, "DSLR Camera", 45000.0, 7), Product(13, "Bluetooth Speaker", 3200.0, 20),
                          Product(14, "Wireless Mouse", 700.0, 50), Product(15, "External Hard Drive", 5500.0, 18), Product(16, "Router", 2300.0, 22),
                          Product(17, "Microwave Oven", 8500.0, 9)}},
        {"Clothes", { Product(5, "T-Shirt", 499.0, 30), Product(6, "Jeans", 1200.0, 20), Product(7, "Jacket", 2500.0, 10)}},
        {"Shoes", { Product(8, "Sneakers", 2000.0, 25), Product(9, "Formal Shoes", 3500.0, 15), Product(10, "Sandals", 800.0, 30)}},
        {"Kitchen", { Product(18, "Mixer Grinder", 3000.0, 10), Product(19, "Pressure Cooker", 1200.0, 18), Product(20, "Electric Kettle", 1500.0, 20),
                      Product(21, "Refrigerator", 25000.0, 5), Product(22, "Gas Stove", 3500.0, 8)}},
        {"Stationery", { Product(23, "Notebook", 50.0, 100), Product(24, "Pen Pack (5 pens)", 120.0, 200), Product(25, "Stapler", 200.0, 50),
                         Product(26, "Highlighter Set", 300.0, 40), Product(27, "Calculator", 700.0, 30)}},
        {"Furniture", { Product(28, "Dining Table", 12000.0, 5), Product(29, "Office Chair", 4500.0, 15), Product(30, "Sofa Set", 25000.0, 3),
                        Product(31, "Bed Frame", 10000.0, 6), Product(32, "Wardrobe", 15000.0, 4)}},
        {"Food", { Product(33, "Milk (1 litre)", 60.0, 50, "05-09-2025"), Product(34, "Eggs (12 pcs)", 70.0, 30, "08-09-2025"),
                   Product(35, "Bread (loaf)", 40.0, 25, "02-09-2025"), Product(36, "Butter (250g)", 150.0, 20, "15-09-2025"),
                   Product(37, "Cheese (200g)", 200.0, 15, "18-09-2025"), Product(38, "Rice (5kg)", 350.0, 40, "31-12-2026"),
                   Product(39, "Wheat Flour (5kg)", 300.0, 35, "31-12-2026"), Product(40, "Sugar (2kg)", 100.0, 50, "31-12-2026"),
                   Product(41, "Cooking Oil (1 litre)", 180.0, 45, "31-12-2026"), Product(42, "Tea Powder (250g)", 120.0, 30, "31-12-2026")}},
        {"Toys", { Product(43, "Toy Car", 350.0, 40), Product(44, "Action Figure", 450.0, 35), Product(45, "Building Blocks Set", 1200.0, 20),
                   Product(46, "Doll", 600.0, 25), Product(47, "Puzzle Game", 400.0, 30), Product(48, "Remote Control Helicopter", 2500.0, 10)}},
        {"Sweets", { Product(49, "Gulab Jamun (6 pcs)", 180.0, 40, "15-09-2025"), Product(50, "Rasgulla (6 pcs)", 200.0, 35, "15-09-2025"),
                     Product(51, "Kaju Katli (250g)", 350.0, 20, "30-09-2025"), Product(52, "Ladoo (500g)", 250.0, 25, "20-09-2025"),
                     Product(53, "Barfi (500g)", 300.0, 30, "25-09-2025"), Product(54, "Jalebi (500g)", 220.0, 15, "12-09-2025")}},
        {"Chocolates", { Product(55, "Dairy Milk (100g)", 50.0, 50, "31-12-2025"), Product(56, "Perk (40g)", 15.0, 100, "31-12-2025"),
                         Product(57, "Munch (30g)", 10.0, 100, "31-12-2025"), Product(58, "KitKat (40g)", 20.0, 80, "31-12-2025"),
                         Product(59, "Bournville (100g)", 60.0, 40, "31-12-2025"), Product(60, "Ferrero Rocher (3 pcs)", 150.0, 25, "31-12-2025"),
                         Product(61, "Snickers (50g)", 25.0, 60, "31-12-2025"), Product(62, "Twix (50g)", 25.0, 60, "31-12-2025")}},
        {"Medicines", { Product(63, "Paracetamol (10 tablets)", 50.0, 100, "31-12-2026"), Product(64, "Cough Syrup (100ml)", 120.0, 50, "30-09-2025"),
                        Product(65, "Antacid Tablets (15 tablets)", 80.0, 75, "31-08-2025"), Product(66, "Vitamin C Tablets (30 tablets)", 150.0, 60, "31-12-2026"),
                        Product(67, "Pain Relief Gel (50g)", 200.0, 40, "31-07-2025")}}
    };

   cout << "Please enter your name: ";
string userName;
getline(cin, userName);
User user(userName);

    int choice;
    do {
        cout << "\n========================================\n";
        cout << "Welcome " << user.getName() << "! Select an option:\n";
        cout << "========================================\n";
        cout << "1. View Products by Category\n";
        cout << "2. Search Product\n";
        cout << "3. Add Product to Cart\n";
        cout << "4. View Cart\n";
        cout << "5. Checkout\n";
        cout << "6. Remove Item from Cart\n";
        cout << "7. Update Cart Quantity\n";
        cout << "8. Exchange Product in Cart\n";
        cout << "9. View Available Coupons\n";
        cout << "10. My Orders\n";
        cout << "11. Cancel Order\n";
        cout << "12. Exit\n";
        cout << "========================================\n";
        cout << "Enter choice: ";
        cin >> choice;
        cin.ignore();

        if(choice == 1) {
            cout << "\nAvailable Categories:\n";
            int catIndex = 1;
            vector<string> catNames;
            for(auto& cat : categories) {
                cout << catIndex << ". " << cat.first << "\n";
                catNames.push_back(cat.first);
                catIndex++;
            }
            cout << "Select Category number to view products: ";
            int catChoice;
            cin >> catChoice;
            cin.ignore();

            if(catChoice > 0 && catChoice <= (int)catNames.size()) {
                showProducts(categories[catNames[catChoice-1]]);
            } else {
                cout << "Invalid category choice.\n";
            }
        }
        else if(choice == 2) {
            cout << "Enter keyword to search: ";
            string keyword; getline(cin, keyword);
            searchProduct(categories, keyword);
        }
        else if(choice == 3) {
            cout << "\nEnter Product ID to add to cart: ";
            int pid, qty;
            cin >> pid;
            cout << "Enter Quantity: ";
            cin >> qty;
            cin.ignore();

            bool found = false;
            for(auto& cat : categories) {
                auto& prods = cat.second;
                auto it = find_if(prods.begin(), prods.end(),
                                  [pid](const Product& p){ return p.getId() == pid; });
                if(it != prods.end()) {
                    found = true;
                    if(qty > 0 && qty <= it->getStock()) {
                        user.getCart().addItem(pid, qty);
                        cout << qty << " units of \"" << it->getName() << "\" added to cart.\n";
                    } else {
                        cout << "Invalid quantity or insufficient stock.\n";
                    }
                    break;
                }
            }
            if(!found) {
                cout << "Invalid Product ID.\n";
            }
        }
        else if(choice == 4) {
            if(user.getCart().empty()) cout << "Cart is empty.\n";
            else {
                cout << "\n========================================\n";
                cout << "          YOUR SHOPPING CART            \n";
                cout << "========================================\n";
                cout << "Product\t\t\tQuantity\tPrice\tTotal\n";
                cout << "--------------------------------------------------------------\n";
                double grandTotal = 0.0;
                for(auto& item : user.getCart().getItems()) {
                    int pid = item.first;
                    int qty = item.second;
                    bool found = false;
                    for(auto& cat : categories) {
                        auto& prods = cat.second;
                        auto it = find_if(prods.begin(), prods.end(), [pid](const Product& p){ return p.getId() == pid; });
                        if(it != prods.end()) {
                            found = true;
                            double total = it->getPrice() * qty;
                            grandTotal += total;
                            cout << it->getName();
                            if(it->getName().length() < 15) cout << "\t\t";
                            else cout << "\t";
                            cout << qty << "\t\t₹" << it->getPrice() << "\t₹" << total << "\n";
                            break;
                        }
                    }
                    if(!found) cout << "Product ID " << pid << " not found.\n";
                }
                cout << "--------------------------------------------------------------\n";
                cout << "Subtotal: ₹" << grandTotal << "\n";
                cout << "\nHave a promo code? Apply it at checkout for discounts!\n";
            }
        }
        else if(choice == 5) {
            if(user.getCart().empty()) { 
                cout << "Your cart is empty. Add items before checkout.\n"; 
                continue; 
            }

            double grandTotal = 0.0;
            bool stockOk = true;

            for(auto& item : user.getCart().getItems()) {
                int pid = item.first;
                int qty = item.second;
                bool found = false;
                for(auto& cat : categories) {
                    auto& prods = cat.second;
                    auto it = find_if(prods.begin(), prods.end(), [pid](const Product& p){ return p.getId() == pid; });
                    if(it != prods.end()) {
                        found = true;
                        if(qty > it->getStock()) { 
                            cout << "Sorry, insufficient stock for product: " << it->getName() << "\n"; 
                            stockOk=false;
                        } else {
                            grandTotal += it->getPrice() * qty;
                        }
                        break;
                    }
                }
                if(!found) { cout << "Product ID " << pid << " not found.\n"; stockOk=false;}
            }

            if(!stockOk) { 
                cout << "Please update your cart and try again.\n"; 
                continue; 
            }

            cout << "\n========================================\n";
            cout << "          ORDER SUMMARY                 \n";
            cout << "========================================\n";
            cout << "Product\t\t\tQuantity\tPrice\tTotal\n";
            cout << "--------------------------------------------------------------\n";

            for(auto& item : user.getCart().getItems()) {
                int pid = item.first;
                int qty = item.second;
                for(auto& cat : categories) {
                    auto& prods = cat.second;
                    auto it = find_if(prods.begin(), prods.end(), [pid](const Product& p){ return p.getId() == pid; });
                    if(it != prods.end()) {
                        double total = it->getPrice() * qty;
                        cout << it->getName();
                        if(it->getName().length() < 15) cout << "\t\t";
                        else cout << "\t";
                        cout << qty << "\t\t₹" << it->getPrice() << "\t₹" << total << "\n";
                        break;
                    }
                }
            }

            cout << "--------------------------------------------------------------\n";
            cout << "Subtotal: ₹" << grandTotal << "\n";
           // Coupon validation and discount application

double discount = 0.0;

cout << "Do you want to apply a promo code? (yes/no): ";
string applyCouponChoice;
getline(cin, applyCouponChoice);

if(applyCouponChoice == "yes" || applyCouponChoice == "y") {
    // List active promo codes
    vector<string> activeCodes;
    cout << "\nAvailable Promo Codes:\n";
    int index = 1;
    for(const auto& c : availableCoupons) {
        if(c.isActive) {
            cout << index << ". " << c.code << " - " << c.description
                 << " (Discount: " << c.discountPercent<<"% upto ₹"<<c.maxDiscountAmount
                 << ", Min Purchase: ₹" << c.minPurchaseAmount << ")\n";
            activeCodes.push_back(c.code);
            index++;
        }
    }

    cout << "Enter the number of the promo code to apply: ";
    int codeChoice;
    cin >> codeChoice;
    cin.ignore();

    if(codeChoice > 0 && codeChoice <= (int)activeCodes.size()) {
        string selectedCode = activeCodes[codeChoice - 1];
        pair<bool, double> result = applyCoupon(availableCoupons, selectedCode, grandTotal);
        if(result.first) {
            discount = result.second;

        } else {
            cout << "Promo code not applicable for this cart.\n";
        }
    } else {
        cout << "Invalid selection. No promo code applied.\n";
    }
}

double finalAmount = grandTotal - discount;

cout << "--------------------------------------------------------------\n";
cout << "TOTAL AMOUNT TO PAY: " << finalAmount << "\n";
cout << "--------------------------------------------------------------\n";

cout << "Enter your delivery address: ";
string address;
getline(cin, address);

string paymentMethod = processPayment(finalAmount);

// Deduct stock after purchase
for (auto item : user.getCart().getItems()) {
    int pid = item.first;
    int qty = item.second;
    for (auto &cat : categories) {
        auto &prods = cat.second;
        for (auto &p : prods) {
            if (p.getId() == pid) {
                p.reduceStock(qty);
                break;
            }
        }
    }
}

cout << "\nORDER PLACED SUCCESSFULLY!\n";
cout << "Order Total: " << finalAmount << "\n";
cout << "Payment Method: " << paymentMethod << "\n";
cout << "Delivery Address: " << address << "\n";
cout << "Thank you for shopping with Punjab Mart!\n";
cout << "Your order will be delivered within 3-5 business days.\n";
// Create a new order
static int orderCounter = 1; // To generate unique order IDs
Order newOrder;
newOrder.orderId = orderCounter++;
newOrder.items = user.getCart().getItems();
newOrder.totalAmount = finalAmount;
newOrder.paymentMethod = paymentMethod;
newOrder.deliveryAddress = address;

// Add the order to the user's order history
user.addOrder(newOrder);

user.getCart().clear();

        }
        else if(choice == 6) removeFromCart(user);
        else if(choice == 7) updateCartQuantity(user, categories);
        else if(choice == 8) {
            cout << "Enter Old Product ID in cart: ";
            int oldPid; cin >> oldPid;
            cout << "Enter New Product ID to exchange: ";
            int newPid; cin >> newPid;
            cout << "Enter quantity for new product: ";
            int qty; cin >> qty; cin.ignore();
            exchangeProduct(user, categories, oldPid, newPid, qty);
        }
        else if(choice == 9) displayAvailableCoupons(availableCoupons);
        
    else if(choice == 10) {
    const auto& orders = user.getOrders();
    if(orders.empty()) {
        cout << "\nYou have no orders yet.\n";
    } else {
        cout << "\n=================== MY ORDERS ===================\n";
        for(const auto& o : orders) {
            cout << "Order ID: " << o.orderId << "\n";
            cout << "Payment Method: " << o.paymentMethod << "\n";
            cout << "Delivery Address: " << o.deliveryAddress << "\n";
            cout << "Items:\n";
            for(const auto& item : o.items) {
                int pid = item.first;
                int qty = item.second;
                for(auto& cat : categories) {
                    auto& prods = cat.second;
                    auto it = find_if(prods.begin(), prods.end(), [pid](const Product& p){ return p.getId() == pid; });
                    if(it != prods.end()) {
                        cout << "  " << it->getName() << " x" << qty << " = ₹" << it->getPrice()*qty << "\n";
                        break;
                    }
                }
            }
            cout << "Total Amount Paid: ₹" << o.totalAmount << "\n";
            cout << "------------------------------------------------\n";
        }
    }
}
else if(choice == 11) {
    cancelOrder(user, categories);
}
else if(choice == 12) cout << "\nThank you "<< user.getName() <<" for shopping with us. Goodbye!\n";
else cout << "Invalid choice, please try again.\n";
    }while(choice != 12);

    return 0;
}